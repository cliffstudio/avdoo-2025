typeof Craft.Formie>"u"&&(Craft.Formie={});Craft.Formie.SubmissionIndex=Craft.BaseElementIndex.extend({editableForms:[],$newSubmissionBtnGroup:null,$newSubmissionBtn:null,startDate:null,endDate:null,init(e,t,i){this.on("selectSource",$.proxy(this,"updateButton")),this.on("selectSite",$.proxy(this,"updateButton")),i.criteria={isIncomplete:null,isSpam:null};var n=t.find("#toolbar:first");Craft.ui.createDateRangePicker({onChange:(function(s,a){this.startDate=s,this.endDate=a,this.updateElements()}).bind(this)}).appendTo(n),this.base(e,t,i),this.setupStateButton()},afterInit(){const e=Craft.Formie.editableForms;if(e)for(var t=0;t<e.length;t++){var i=e[t];this.getSourceByKey("form:"+i.id)&&this.editableForms.push(i)}this.base()},setupStateButton(){let e=$("<button/>",{type:"button",class:"btn menubtn statusmenubtn"}).append($("<span/>",{class:"status disabled"}),$("<span/>",{text:Craft.t("formie","All")})),t=$("<div/>",{class:"menu"}).append($("<ul/>",{class:"padded"}).append($("<li/>").append($("<a/>",{"data-state":"all"}).append($("<span/>",{class:"status disabled"}),$("<span/>",{text:Craft.t("formie","All")}))),$("<li/>").append($("<a/>",{"data-state":"complete"}).append($("<span/>",{class:"icon","data-icon":"check"}),$("<span/>",{text:Craft.t("formie","Complete")}))),$("<li/>").append($("<a/>",{"data-state":"incomplete"}).append($("<span/>",{class:"icon","data-icon":"draft"}),$("<span/>",{text:Craft.t("formie","Incomplete")}))),$("<li/>").append($("<a/>",{"data-state":"spam"}).append($("<span/>",{class:"icon","data-icon":"bug"}),$("<span/>",{text:Craft.t("formie","Spam")})))));var i=this,n=new Garnish.Menu(t,{onOptionSelect:function(l){var r=$(l);e.html(r.html()),n.setPositionRelativeToAnchor(),t.find(".sel").removeClass("sel"),r.addClass("sel"),r.data("state")==="all"&&(i.settings.criteria.isIncomplete=null,i.settings.criteria.isSpam=null),r.data("state")==="complete"&&(i.settings.criteria.isIncomplete=!1,i.settings.criteria.isSpam=!1),r.data("state")==="incomplete"&&(i.settings.criteria.isIncomplete=!0,i.settings.criteria.isSpam=!1),r.data("state")==="spam"&&(i.settings.criteria.isIncomplete=!1,i.settings.criteria.isSpam=!0),Craft.setQueryParam("state",r.data("state")),i.updateElements()}});new Garnish.MenuBtn(e,n),e.insertBefore($(".search-container"));const s=Craft.getQueryParam("state")?Craft.getQueryParam("state"):Craft.Formie.defaultState,a=n.$options.filter("[data-state="+s+"]");a.length&&n.selectOption(a[0])},getViewClass(e){return e==="table"?Craft.Formie.SubmissionTableView:this.base(e)},getDefaultSort(){return["dateCreated","desc"]},getDefaultSourceKey(){if(this.settings.context==="index"&&typeof defaultFormieFormHandle<"u")for(var e=0;e<this.$sources.length;e++){var t=$(this.$sources[e]);if(t.data("handle")===defaultFormieFormHandle)return t.data("key")}return this.base()},updateButton(){if(this.$source){var e=this.$source.data("handle"),t,i,n;if(this.editableForms.length){this.$newSubmissionBtnGroup&&this.$newSubmissionBtnGroup.remove();var s;if(e){for(t=0;t<this.editableForms.length;t++)if(this.editableForms[t].handle===e){s=this.editableForms[t];break}}this.$newSubmissionBtnGroup=$('<div class="btngroup submit"/>');var a;if(s?(i=this._getFormTriggerHref(s),n=this.settings.context==="index"?Craft.t("formie","New submission"):Craft.t("formie","New {form} submission",{form:s.name}),this.$newSubmissionBtn=$('<a class="btn submit add icon" '+i+' role="button" tabindex="0">'+Craft.escapeHtml(n)+"</a>").appendTo(this.$newSubmissionBtnGroup),this.settings.context!=="index"&&this.addListener(this.$newSubmissionBtn,"click",function(h){this._openCreateSubmissionModal(h.currentTarget.getAttribute("data-id"))}),this.editableForms.length>1&&(a=$("<button/>",{type:"button",class:"btn submit menubtn"}).appendTo(this.$newSubmissionBtnGroup))):this.$newSubmissionBtn=a=$("<button/>",{type:"button",class:"btn submit add icon menubtn",text:Craft.t("formie","New submission")}).appendTo(this.$newSubmissionBtnGroup),a){var l='<div class="menu"><ul>';for(t=0;t<this.editableForms.length;t++){var r=this.editableForms[t];(this.settings.context==="index"&&$.inArray(this.siteId,r.sites)!==-1||this.settings.context!=="index"&&r!==s)&&(i=this._getFormTriggerHref(r),n=this.settings.context==="index"?r.name:Craft.t("formie","New {form} submission",{form:r.name}),l+="<li><a "+i+">"+Craft.escapeHtml(n)+"</a></li>")}l+="</ul></div>",$(l).appendTo(this.$newSubmissionBtnGroup);var d=new Garnish.MenuBtn(a);this.settings.context!=="index"&&d.on("optionSelect",h=>{this._openCreateSubmissionModal(h.option.getAttribute("data-id"))})}this.addButton(this.$newSubmissionBtnGroup)}if(this.settings.context==="index"){var f="formie/submissions";e&&(f+="/"+e),Craft.setPath(f)}}},getViewParams:function(){var e=this.base();if(this.startDate||this.endDate){var t=this.$source.data("date-attr")||"dateCreated";e.criteria[t]=["and"],this.startDate&&e.criteria[t].push(">="+this.startDate.getTime()/1e3),this.endDate&&e.criteria[t].push("<"+(this.endDate.getTime()/1e3+86400))}return e},getSite(){if(this.siteId)return Craft.sites.find(e=>e.id==this.siteId)},_getFormTriggerHref(e){if(this.settings.context==="index"){const t=`formie/submissions/${e.handle}/new`,i=this.getSite(),n=i?{site:i.handle}:void 0;return`href="${Craft.getUrl(t,n)}"`}return`data-id="${e.id}"`},_openCreateSubmissionModal(e){if(!this.$newSubmissionBtn.hasClass("loading")){for(var t,i=0;i<this.editableForms.length;i++)if(this.editableForms[i].id==e){t=this.editableForms[i];break}if(t){this.$newSubmissionBtn.addClass("inactive");var n=this.$newSubmissionBtn.text();this.$newSubmissionBtn.text(Craft.t("formie","New {form} submission",{form:t.name})),Craft.createElementEditor(this.elementType,{hudTrigger:this.$newSubmissionBtnGroup,siteId:this.siteId,attributes:{formId:e},onHideHud:()=>{this.$newSubmissionBtn.removeClass("inactive").text(n)},onSaveElement:s=>{var a="form:"+t.id;this.sourceKey!==a&&this.selectSourceByKey(a),this.selectElementAfterUpdate(s.id),this.updateElements()}})}}}});Craft.Formie.SubmissionTableView=Craft.TableElementIndexView.extend({afterInit(){this.$explorerContainer=$('<div class="chart-explorer-container"></div>').prependTo(this.$container),this.$chartExplorer=$('<div class="chart-explorer"></div>').appendTo(this.$explorerContainer),this.$chartContainer=$('<div class="chart-container"></div>').appendTo(this.$chartExplorer),this.$chart=$('<div class="chart"></div>').appendTo(this.$chartContainer),this.loadReport(),this.base()},groupAndFillData(e){const t=Object.entries(e),i=new Date(t[0][0]),n=new Date(t[t.length-1][0]),s=(i-n)/(1e3*60*60*24);let a;s>=730?a="year":s>=60?a="month":s>=2?a="day":a="hour";const l=h=>{var o=new Date(h.getTime());return a==="year"?(o.setMonth(0),o.setDate(1),o.setHours(0),o.setMinutes(0),o.setSeconds(0)):a==="month"?(o.setDate(1),o.setHours(0),o.setMinutes(0),o.setSeconds(0)):a==="day"?(o.setHours(0),o.setMinutes(0),o.setSeconds(0)):a==="hour"&&(o.setMinutes(0),o.setSeconds(0)),a==="hour"?o.toISOString().slice(0,19).replace("T"," "):o.toISOString().split("T")[0]},r={};let d=new Date(n);for(;d<=i||Object.keys(r).length<2;){const h=l(d);r[h]=0,a==="year"?d.setFullYear(d.getFullYear()+1):a==="month"?d.setMonth(d.getMonth()+1):a==="day"?d.setDate(d.getDate()+1):d.setHours(d.getHours()+1)}for(const[h,o]of t){var f=l(new Date(h));f in r&&(r[f]+=o)}return{data:Object.entries(r).map(([h,o])=>[h,o]),group:a}},loadReport(){const e=$(this.elementIndex.$elements).find("[data-titlecell] .element");if(!e.length){this.$explorerContainer.addClass("chart-empty");return}this.chart||(this.chart=new Craft.charts.Area(this.$chart));let t={};e.each(function(r,d){let f=$(d).data("date-created");t[f]||(t[f]=0),t[f]++});const i=this.groupAndFillData(t);var s={columns:[{type:i.group==="hour"?"datetime":"date",label:"Date"},{type:"number",label:"Submissions"}],rows:i.data},a=new Craft.charts.DataTable(s),l={orientation:Craft.orientation,formats:{numberFormat:",.0f"},dataScale:i.group};this.chart.draw(a,l)}});(function(e){e(document).on("click",".js-fui-submission-modal-send-btn",function(t){t.preventDefault(),new Craft.Formie.SendNotificationModal(e(this).data("id"))})})(jQuery);Craft.Formie.SendNotificationModal=Garnish.Modal.extend({init(e){this.$form=$('<form class="modal fui-send-notification-modal" method="post" accept-charset="UTF-8"/>').appendTo(Garnish.$bod),this.$body=$('<div class="body"><div class="spinner big"></div></div>').appendTo(this.$form);var t=$('<div class="footer"/>').appendTo(this.$form),i=$('<div class="buttons right"/>').appendTo(t);this.$cancelBtn=$('<button type="button" class="btn">'+Craft.t("formie","Cancel")+"</button>").appendTo(i),this.$updateBtn=$('<button type="submit" class="btn submit">'+Craft.t("formie","Send Email Notification")+"</button>").appendTo(i),this.$footerSpinner=$('<div class="spinner right hidden"/>').appendTo(t),Craft.initUiElements(this.$form),this.addListener(this.$cancelBtn,"click","onFadeOut"),this.addListener(this.$updateBtn,"click","onSend"),this.base(this.$form);var n={id:e};Craft.sendActionRequest("POST","formie/submissions/get-send-notification-modal-content",{data:n}).then(s=>{this.$body.html(s.data.modalHtml),Craft.appendHeadHtml(s.data.headHtml),Craft.appendBodyHtml(s.data.footHtml)})},onFadeOut(){this.$form.remove(),this.$shade.remove()},onSend(e){e.preventDefault(),this.$footerSpinner.removeClass("hidden");var t=this.$form.serialize();Craft.sendActionRequest("POST","formie/submissions/send-notification",{data:t}).then(i=>{location.reload()}).catch(({response:i})=>{i&&i.data&&i.data.message?Craft.cp.displayError(i.data.message):Craft.cp.displayError()}).finally(()=>{this.$footerSpinner.addClass("hidden")})}});Craft.registerElementIndexClass("verbb\\formie\\elements\\Submission",Craft.Formie.SubmissionIndex);typeof Craft.Formie>"u"&&(Craft.Formie={});Craft.Formie.UnmarkSpamUserModal=Garnish.Modal.extend({$saveSubmitBtn:null,init:function(e){this.id=Math.floor(Math.random()*1e9),e=$.extend(Craft.Formie.UnmarkSpamUserModal,e);let t=$('<form class="modal fitted formie-unmark-spam-modal" method="post" accept-charset="UTF-8">'+Craft.getCsrfInput()+"</form>").appendTo(Garnish.$bod),i=$('<div class="body"><div class="content-summary"><p>'+Craft.t("formie","Should any additional actions be performed?")+"</p></div></div>").appendTo(t);Craft.ui.createLightswitchField({label:Craft.t("formie","Send Notifications"),instructions:Craft.t("formie","Whether any Email Notifications should be sent."),name:"sendNotifications"}).appendTo(i),Craft.ui.createLightswitchField({label:Craft.t("formie","Trigger Integrations"),instructions:Craft.t("formie","Whether any Integrations should be triggered."),name:"triggerIntegrations"}).appendTo(i);let n=$('<div class="buttons right"/>').appendTo(i),s=$("<button/>",{type:"button",class:"btn",text:Craft.t("app","Cancel")}).appendTo(n);this.$saveSubmitBtn=Craft.ui.createSubmitButton({label:Craft.t("formie","Unmark as Spam"),spinner:!0}).appendTo(n),this.addListener(s,"click","hide"),this.addListener(t,"submit","handleSubmit"),this.base(t,e)},handleSubmit:function(e){this.$saveSubmitBtn.addClass("loading"),this.disable();try{this.settings.onSubmit()===!1&&e.preventDefault()}catch(t){throw e.preventDefault(),this.$saveSubmitBtn.removeClass("loading"),t}}},{defaults:{onSubmit:$.noop}});typeof Craft.Formie>"u"&&(Craft.Formie={});(function(e){e(document).on("click",".js-fui-notification-modal-resend-btn",function(t){t.preventDefault(),new Craft.Formie.ResendNotificationModal(e(this).data("id"))})})(jQuery);Craft.Formie.ResendNotificationModal=Garnish.Modal.extend({init(e){this.$form=$('<form class="modal fui-resend-modal" method="post" accept-charset="UTF-8"/>').appendTo(Garnish.$bod),this.$body=$('<div class="body"><div class="spinner big"></div></div>').appendTo(this.$form);var t=$('<div class="footer"/>').appendTo(this.$form),i=$('<div class="buttons right"/>').appendTo(t);this.$cancelBtn=$('<button type="button" class="btn">'+Craft.t("formie","Cancel")+"</button>").appendTo(i),this.$updateBtn=$('<button type="submit" class="btn submit">'+Craft.t("formie","Resend Email Notification")+"</button>").appendTo(i),this.$footerSpinner=$('<div class="spinner right hidden"/>').appendTo(t),Craft.initUiElements(this.$form),this.addListener(this.$cancelBtn,"click","onFadeOut"),this.addListener(this.$updateBtn,"click","onResend"),this.base(this.$form);var n={id:e};Craft.sendActionRequest("POST","formie/sent-notifications/get-resend-modal-content",{data:n}).then(s=>{this.$body.html(s.data.modalHtml),Craft.appendHeadHtml(s.data.headHtml),Craft.appendBodyHtml(s.data.footHtml)})},onFadeOut(){this.$form.remove(),this.$shade.remove()},onResend(e){e.preventDefault(),this.$footerSpinner.removeClass("hidden");var t=this.$form.serialize();Craft.sendActionRequest("POST","formie/sent-notifications/resend",{data:t}).then(i=>{location.reload()}).catch(({response:i})=>{i&&i.data&&i.data.message?Craft.cp.displayError(i.data.message):Craft.cp.displayError()}).finally(()=>{this.$footerSpinner.addClass("hidden")})}});Craft.Formie.BulkResendElementAction=Garnish.Base.extend({init(e){new Craft.ElementActionTrigger({type:e,batch:!0,activate(t){new Craft.Formie.BulkResendModal(t.find(".element"),t)}})}});Craft.Formie.BulkResendModal=Garnish.Modal.extend({init(e,t){this.$element=e,this.$selectedItems=t;var i=t.length==1?"":"s",n="<strong>"+t.length+"</strong> notification"+i;this.$form=$('<form class="modal fitted" method="post" accept-charset="UTF-8"/>').appendTo(Garnish.$bod),this.$body=$('<div class="body" style="max-width: 560px;"><h2>'+Craft.t("formie","Bulk Resend Email Notification")+"</h2><p>"+Craft.t("formie","You are about to resend {desc}. You can resend each notification to their original recipients, or choose specific recipients.",{desc:n})+"</p></div>").appendTo(this.$form);var s=Craft.ui.createSelectField({label:Craft.t("formie","Recipients"),name:"recipientsType",options:[{label:Craft.t("formie","Original Recipients"),value:"original"},{label:Craft.t("formie","Custom Recipients"),value:"custom"}],toggle:!0,targetPrefix:"type-"}).appendTo(this.$body),a=$("<div/>",{id:"type-custom",class:"hidden"}).appendTo(this.$body);Craft.ui.createTextField({label:Craft.t("formie","Custom Recipients"),instructions:Craft.t("formie","Provide recipients for each email notification to be sent to. For multiple recipients, separate each with a comma."),name:"to",required:!0}).appendTo(a),this.$selectedItems.each((d,f)=>{$("<input/>",{type:"hidden",name:"ids[]",value:$(f).data("id")}).appendTo(this.$body)});var l=$('<div class="footer"/>').appendTo(this.$form),r=$('<div class="buttons right"/>').appendTo(l);this.$cancelBtn=$('<button type="button" class="btn">'+Craft.t("formie","Cancel")+"</button>").appendTo(r),this.$updateBtn=$('<button type="submit" class="btn submit">'+Craft.t("formie","Resend Email Notifications")+"</button>").appendTo(r),this.$footerSpinner=$('<div class="spinner right hidden"/>').appendTo(l),this.addListener(this.$cancelBtn,"click","onFadeOut"),this.addListener(this.$updateBtn,"click","onResend"),this.addListener(s,"change","onSelectChange"),this.base(this.$form)},onSelectChange(){this.updateSizeAndPosition()},onFadeOut(){this.$form.remove(),this.$shade.remove()},onResend(e){e.preventDefault(),this.$footerSpinner.removeClass("hidden");var t=this.$form.serialize();Craft.sendActionRequest("POST","formie/sent-notifications/bulk-resend",{data:t}).then(i=>{location.reload()}).catch(({response:i})=>{i&&i.data&&i.data.message?Craft.cp.displayError(i.data.message):Craft.cp.displayError()}).finally(()=>{this.$footerSpinner.addClass("hidden")})}});typeof Craft.Formie>"u"&&(Craft.Formie={});jQuery;
//# sourceMappingURL=formie-cp.js.map
